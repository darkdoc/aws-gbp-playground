# Checks that env variables are set, that clusters are reachable
# Sets aws_region and {hub,spoke}_cluster_name and {hub,spoke}_fqdn facts
- name: Set HUBCONFIG and SPOKECONFIG facts from env variables
  ansible.builtin.set_fact:
    HUBCONFIG: "{{ lookup('env', 'HUBCONFIG') }}"
    SPOKECONFIG: "{{ lookup('env', 'SPOKECONFIG') }}"

- name: Check for correct HUBCONFIG variable
  ansible.builtin.fail:
    msg: "HUBCONFIG variable needs to be set and pointing to the HUB kubeconfig file"
  when:
    HUBCONFIG is not defined or HUBCONFIG | length == 0

- name: Check for correct SPOKECONFIG env variable
  ansible.builtin.fail:
    msg: "SPOKECONFIG variable needs to be set and pointing to the REGION kubeconfig file"
  when:
    SPOKECONFIG is not defined or SPOKECONFIG | length == 0

- name: Show the two cluster kubeconfig paths
  ansible.builtin.debug:
    msg: "HUBCONFIG: {{ HUBCONFIG }} - SPOKECONFIG: {{ SPOKECONFIG }}"

- name: Get cluster routes and set facts
  ansible.builtin.shell: |
    oc get Ingress.config.openshift.io/cluster -o jsonpath='{.spec.domain}'
  environment:
    KUBECONFIG: "{{ item.config }}"
  register: route_result
  loop:
    - { name: "hub", config: "{{ HUBCONFIG }}" }
    - { name: "spoke", config: "{{ SPOKECONFIG }}" }

- name: Set cluster route info dynamically
  ansible.builtin.set_fact:
    "{{ item.item.name }}_cluster_name": "{{ (item.stdout | split('.'))[1] }}"
    "{{ item.item.name }}_fqdn": "{{ (item.stdout | split('.'))[1:] | join('.') }}"
  loop: "{{ route_result.results }}"        

- name: Get clusters' aws region
  ansible.builtin.shell: |
    oc get infrastructure cluster -o jsonpath='{.status.platformStatus.aws.region}'
  environment:
    KUBECONFIG: "{{ item.config }}"
  register: aws_region_result
  loop:
    - { name: "hub", config: "{{ HUBCONFIG }}" }
    - { name: "spoke", config: "{{ SPOKECONFIG }}" }

- name: Set cluster aws region info dynamically
  ansible.builtin.set_fact:
    "{{ item.item.name }}_aws_region": "{{ item.stdout }}"
  loop: "{{ aws_region_result.results }}"        

- name: We only support clusters in the same region
  ansible.builtin.assert:
    that:
      - hub_aws_region == spoke_aws_region
    fail_msg: "FATAL: we do not support clusters in different regions for now"
  # FIXME: for now we skip this check
  failed_when: false

- name: Set aws region
  ansible.builtin.set_fact:
    aws_region: "{{ hub_aws_region }}"
