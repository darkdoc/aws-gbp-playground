---
- name: Playbook to set up the BGP routing with a client ec2 in aws
  hosts: localhost
  gather_facts: false
  become: false
  vars:
    wait_for_ssh_timeout: 600
  vars_files:
    # Use this to override stuff that won't be committed to git
    - ../overrides.yml

  tasks:
    - name: Checks
      ansible.builtin.include_tasks: check_task.yml

    - name: Get ami image
      ansible.builtin.shell: |
        aws --profile {{ aws_profile }} ec2 describe-images \
        --owners {{ aws_ami_owner }} \
        --filters "Name=name,Values={{ aws_ami_name }}*" "Name=state,Values=available" "Name=architecture,Values={{ aws_ami_arch }}" \
        --region {{ aws_region }} \
        --query 'sort_by(Images, &CreationDate)[-1].ImageId' \
        --output text
      register: test_client_ec2_ami_image_id_raw

    - name: Set ami image fact
      ansible.builtin.set_fact:
        test_client_ec2_ami_image_id: "{{ test_client_ec2_ami_image_id_raw.stdout }}"

    - name: Print ami image use
      ansible.builtin.debug:
        msg: "Using AMI image: {{ test_client_ec2_ami_image_id }}"

    - name: Create key pair to access ec2 with ssh
      amazon.aws.ec2_key:
        profile: "{{ aws_profile }}"
        region: "{{ aws_region }}"
        name: "{{ test_client_ec2_ssh_key_name }}"
        key_material: "{{ ssh_pubkey }}"

    - ansible.builtin.include_tasks: network_task.yml
      loop:
        - { name: "hub", config: "{{ HUBCONFIG }}", cluster_name: "{{ hub_cluster_name }}" }
        - { name: "spoke", config: "{{ SPOKECONFIG }}", cluster_name: "{{ spoke_cluster_name }}" }
      loop_control:
        loop_var: ocp

    - name: Start an ec2 instance (test-client)
      amazon.aws.ec2_instance:
        profile: "{{ aws_profile }}"
        region: "{{ aws_region }}"
        name: "test-client-{{ hub_cluster_name }}"
        state: started
        wait: true
        vpc_subnet_id: "{{ hub_public_subnet_id }}"
        instance_type: "{{ test_client_ec2_instance_type }}"
        key_name: "{{ test_client_ec2_ssh_key_name }}"
        security_groups: "test-client-{{ hub_cluster_name }}-security-group"
        image_id: "{{ test_client_ec2_ami_image_id }}"
        network:
          assign_public_ip: true
        user_data: |
          #cloud-config
          chpasswd:
            expire: false
          user: ec2-user
          packages:
          - tmux
          - nc
          - traceroute
          - tcpdump
          - vim
      register: client_instance_info

    - name: Set instance facts
      ansible.builtin.set_fact:
        client_public_ip: "{{ client_instance_info.instances[0].public_ip_address }}"
        client_private_ip: "{{ client_instance_info.instances[0].private_ip_address }}"
        client_instance_id: "{{ client_instance_info.instances[0].instance_id }}"

    - name: Show instance details
      ansible.builtin.debug:
        msg:
          public_ip: "{{ client_public_ip }}"
          private_ip: "{{ client_private_ip }}"
          instance_id: "{{ client_instance_id }}"
          spoke_public_subnet_id: "{{ spoke_public_subnet_id }}"

    - name: Set dns facts (1)
      ansible.builtin.set_fact:
        record_name: "bgp_{{ aws_arn_userid }}"

    - name: Set dns facts (2)
      ansible.builtin.set_fact:
        fqdn: "{{ record_name }}.{{ hosted_zone | regex_replace('\n$','') }}"
        fqdn_nodot: "{{ record_name }}.{{ hosted_zone | regex_replace('\n$','') | regex_replace('\\.$','') }}"

    - name: Create/Update A record
      amazon.aws.route53:
        profile: "{{ aws_profile }}"
        zone: "{{ hosted_zone }}"
        record: "{{ fqdn }}"
        type: A
        ttl: 60
        value: "{{ client_public_ip }}"
        overwrite: true
        state: present
      register: r53

    - name: Show DNS
      ansible.builtin.debug:
        msg:
          fqdn: "{{ fqdn }}"
          r53: "{{ r53 }}"

    - name: Wait for SSH to be available
      ansible.builtin.wait_for:
        host: "{{ client_public_ip }}"
        port: 22
        timeout: "{{ wait_for_ssh_timeout }}"
        state: started

    - name: Fetch host key via ssh-keyscan ip
      ansible.builtin.command: "ssh-keyscan -H {{ client_public_ip }}"
      register: scanned_ip
      changed_when: false

    - name: Add new host to in-memory inventory
      ansible.builtin.add_host:
        name: "{{ fqdn_nodot }}"
        ansible_host: "{{ client_public_ip }}"
        groups: ["client_node"]
        ansible_user: ec2-user
        key: "{{ scanned_ip.stdout }}"

    - name: Get ENI in spoke's vpc subnet
      amazon.aws.ec2_eni_info:
        profile: "{{ aws_profile }}"
        region: "{{ aws_region }}"
        filters:
          attachment.instance-id: "{{ client_instance_info.instance_ids[0] }}"
          subnet-id: "{{ spoke_public_subnet_id }}"
      register: ec2_eni_info_raw

    - name: Create ENI in spoke's vpc subnet if not exists
      amazon.aws.ec2_eni:
        profile: "{{ aws_profile }}"
        region: "{{ aws_region }}"
        subnet_id: "{{ spoke_public_subnet_id }}" # ⬅️ Subnet in VPC B, but same AZ
        security_groups: "test-client-{{ spoke_cluster_name }}-security-group"
        instance_id: "{{ client_instance_info.instance_ids[0] }}"
        device_index: 1  # ⬅️ Must be 1 or greater for a secondary NIC
        attached: true
        tags:
          Name: "{{ spoke_cluster_name }}-client-vpc-nic"
      register: eni_created
      when: ec2_eni_info_raw['network_interfaces'] | length == 0

    - name: Debug eni info
      ansible.builtin.debug:
        msg: "{{ eni_created.interface.id if (ec2_eni_info_raw['network_interfaces'] | length == 0) else ec2_eni_info_raw['network_interfaces'][0]['id'] }}"

    # Modify the interface to enable the delete_on_terminaton flag
    - name: Make sure we delete the ENI when we remove the ec2 VM
      amazon.aws.ec2_eni:
        profile: "{{ aws_profile }}"
        region: "{{ aws_region }}"
        eni_id: "{{ eni_id }}"
        delete_on_termination: true
      vars:
        eni_id: "{{ eni_created.interface.id if (ec2_eni_info_raw['network_interfaces'] | length == 0) else ec2_eni_info_raw['network_interfaces'][0]['id']  }}"
